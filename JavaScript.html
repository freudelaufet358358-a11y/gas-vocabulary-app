<script>
// ===================================
// グローバル変数
// ===================================
let allWords = [];
let currentTestWords = [];
let currentQuestion = null;
let currentQuestionIndex = 0;
let totalQuestions = 0;
let correctAnswers = 0;
let testMode = '';
let questionDirection = '';
let allWordsForChoices = [];
let testResults = [];
let userStats = {};
let testStartTime = null;
let autoSaveEnabled = true;
let recentlyTestedIds = []; // 過去30問で出題された単語ID
let pendingTestResults = []; // オフライン時の保留データ

// 音声関連
let speechSynthesis = window.speechSynthesis;
let speechSupported = 'speechSynthesis' in window;
let currentUtterance = null; // ガベージコレクション対策

// ★修正: オンライン判定を追加
let isOnline = navigator.onLine;

// 現在選択中の単語帳
let currentBookId = 'target1900';
let availableBooks = [];

// 最後のテスト設定を保存
let lastTestSettings = {
  mode: '',
  startRow: 1,
  endRow: 10,
  direction: 'random',
  bookId: ''
};

// キャッシュとUI設定
let cachedWordData = {};  // 単語帳ごとにキャッシュを保存
let cachedStatsData = null;
const CACHE_DURATION = 30 * 1000; // 30秒キャッシュ

// UI設定
let uiSettings = {
  fontSize: 2,
  wordListFilter: 'all',
  currentBookId: 'target1900',
  customTestRange: { start: 1, end: 10 }
};

// ===================================
// 初期化
// ===================================
window.onload = function() {
  console.log('アプリケーション初期化開始');
  
  // オンライン/オフラインイベントリスナー
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  
  // UI設定を読み込み
  loadUISettings();
  
  // オフライン時の保留結果を読み込み
  loadPendingResults();
  
  // フォントサイズ適用
  applyUISettings();
  
  // 現在の単語帳IDを復元
  currentBookId = uiSettings.currentBookId || 'target1900';
  
  // データを読み込み
  loadWordData();
};

// ===================================
// UI設定の管理
// ===================================
function loadUISettings() {
  try {
    const saved = localStorage.getItem('uiSettings');
    if (saved) {
      const loadedSettings = JSON.parse(saved);
      uiSettings = { ...uiSettings, ...loadedSettings };
      
      if (uiSettings.customTestRange) {
        const startEl = document.getElementById('start-row');
        const endEl = document.getElementById('end-row');
        if(startEl) startEl.value = uiSettings.customTestRange.start;
        if(endEl) endEl.value = uiSettings.customTestRange.end;
      }
    }
  } catch (e) {
    console.error('UI設定の読み込みエラー:', e);
  }
}

function saveUISettings() {
  try {
    localStorage.setItem('uiSettings', JSON.stringify(uiSettings));
  } catch (e) {
    console.error('UI設定の保存エラー:', e);
  }
}

function applyUISettings() {
  const fontSizeClasses = ['font-small', 'font-medium', 'font-large', 'font-xlarge'];
  document.body.classList.remove(...fontSizeClasses);
  const fontSizeClass = fontSizeClasses[uiSettings.fontSize - 1] || 'font-medium';
  document.body.classList.add(fontSizeClass);
  
  const slider = document.getElementById('font-size-slider');
  if (slider) {
    slider.value = uiSettings.fontSize;
    updateFontPreview();
  }
  updateFilterButtons();
}

function toggleSettings() {
  const panel = document.getElementById('settings-panel');
  panel.classList.toggle('hidden');
}

// スライダーイベント
document.addEventListener('DOMContentLoaded', function() {
  const slider = document.getElementById('font-size-slider');
  if (slider) {
    slider.addEventListener('input', function(e) {
      uiSettings.fontSize = parseInt(e.target.value);
      applyUISettings();
      saveUISettings();
    });
  }
});

function updateFontPreview() {
  const preview = document.getElementById('font-preview');
  if (preview) {
    const sizeNames = ['小さめ', '標準', '大きめ', '特大'];
    preview.textContent = `プレビュー (${sizeNames[uiSettings.fontSize - 1]}): これがサンプルテキストです`;
  }
}

// ===================================
// 単語帳切り替え機能
// ===================================
function switchBook(bookId) {
  console.log('単語帳を切り替え:', bookId);
  currentBookId = bookId;
  uiSettings.currentBookId = bookId;
  saveUISettings();
  loadWordData();
}

function updateBookSelectors() {
  const selectors = [
    document.getElementById('book-selector'),
    document.getElementById('book-selector-modal')
  ];
  
  selectors.forEach(selector => {
    if (selector) {
      selector.innerHTML = '';
      availableBooks.forEach(book => {
        const option = document.createElement('option');
        option.value = book.id;
        option.textContent = book.name;
        if (book.id === currentBookId) {
          option.selected = true;
        }
        selector.appendChild(option);
      });
    }
  });
  
  const currentBook = availableBooks.find(b => b.id === currentBookId);
  if (currentBook) {
    const nameElements = [
      document.getElementById('current-book-name'),
      document.getElementById('current-book-display-name'),
      document.getElementById('modal-book-name')
    ];
    nameElements.forEach(el => {
      if (el) el.textContent = currentBook.name;
    });
  }
}

// ===================================
// 単語帳フィルター機能
// ===================================
function setWordFilter(filter) {
  uiSettings.wordListFilter = filter;
  saveUISettings();
  updateFilterButtons();
  
  const searchInputs = document.querySelectorAll('.word-search-input'); // クラス指定に変更
  searchInputs.forEach(input => input.value = '');
  
  const filteredWords = getFilteredWords();
  displayWordList(filteredWords);
}

function updateFilterButtons() {
  const selectElements = [
    document.getElementById('word-filter-select'),
    document.getElementById('word-filter-select-modal')
  ];
  selectElements.forEach(select => {
    if (select) select.value = uiSettings.wordListFilter;
  });
}

// ===================================
// データキャッシュ機能
// ===================================
function loadWordData() {
  updateLoadingMessage('キャッシュ確認中...');
  
  const cached = loadFromCache();
  if (cached) {
    console.log('キャッシュからデータを読み込みました');
    updateLoadingMessage('キャッシュから読み込み完了', '即座に起動します');
    
    allWords = cached.words;
    allWordsForChoices = cached.words;
    userStats = cached.stats;
    recentlyTestedIds = cached.recentlyTestedIds || [];
    availableBooks = cached.availableBooks || [];
    
    setTimeout(() => {
      initializeMenu();
      changeScreen('menu-screen');
    }, 100);
    
    if(isOnline) refreshDataInBackground();
    return;
  }
  
  updateLoadingMessage('データ取得中...', '初回起動のため少しお待ちください');
  fetchWordData();
}

function updateLoadingMessage(main, detail = '') {
  const mainEl = document.getElementById('loading-message');
  const detailEl = document.getElementById('loading-detail');
  if (mainEl) mainEl.textContent = main;
  if (detailEl) detailEl.textContent = detail;
}

function fetchWordData() {
  if (!isOnline) {
    const cached = loadFromCache();
    if (cached) {
      allWords = cached.words;
      allWordsForChoices = cached.words;
      userStats = cached.stats;
      recentlyTestedIds = cached.recentlyTestedIds || [];
      availableBooks = cached.availableBooks || [];
      initializeMenu();
      changeScreen('menu-screen');
    } else {
      alert('オフライン状態でキャッシュデータがありません。');
    }
    return;
  }
  
  updateLoadingMessage('サーバーと通信中...', '単語データを取得しています');
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        allWords = response.words;
        allWordsForChoices = response.words;
        userStats = response.stats;
        recentlyTestedIds = response.recentlyTestedIds || [];
        availableBooks = response.availableBooks || [];
        
        if (response.bookInfo) {
          currentBookId = response.bookInfo.id;
          uiSettings.currentBookId = currentBookId;
          saveUISettings();
        }
        
        saveToCache(response.words, response.stats, response.recentlyTestedIds, response.availableBooks);
        
        setTimeout(() => {
          initializeMenu();
          changeScreen('menu-screen');
        }, 200);
      } else {
        alert(response.message || 'データの読み込みに失敗しました。');
        changeScreen('menu-screen');
      }
    })
    .withFailureHandler(function(error) {
      console.error('データ読み込みエラー:', error);
      handleOfflineError();
    })
    .getWordLists(currentBookId);
}

function refreshDataInBackground() {
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        saveToCache(response.words, response.stats, response.recentlyTestedIds, response.availableBooks);
        allWords = response.words;
        allWordsForChoices = response.words;
        userStats = response.stats;
        recentlyTestedIds = response.recentlyTestedIds || [];
        availableBooks = response.availableBooks || [];
        updateDashboard();
        console.log('バックグラウンド更新完了');
      }
    })
    .withFailureHandler(error => console.log('BG更新エラー:', error))
    .getWordLists(currentBookId);
}

function saveToCache(words, stats, recentlyTested = [], books = []) {
  try {
    cachedWordData[currentBookId] = {
      words: words,
      stats: stats,
      recentlyTestedIds: recentlyTested,
      availableBooks: books,
      timestamp: Date.now()
    };
    localStorage.setItem('wordDataCache_' + currentBookId, JSON.stringify(cachedWordData[currentBookId]));
  } catch (e) {
    console.error('キャッシュ保存エラー:', e);
  }
}

function loadFromCache() {
  try {
    const cached = localStorage.getItem('wordDataCache_' + currentBookId);
    if (!cached) return null;
    const cacheData = JSON.parse(cached);
    const age = Date.now() - cacheData.timestamp;
    if (age < CACHE_DURATION) {
      return {
        words: cacheData.words,
        stats: cacheData.stats,
        recentlyTestedIds: cacheData.recentlyTestedIds || [],
        availableBooks: cacheData.availableBooks || []
      };
    }
    return null;
  } catch (e) {
    return null;
  }
}

// ===================================
// オンライン/オフライン対応
// ===================================
function handleOnline() {
  console.log('オンライン復帰');
  isOnline = true;
  syncPendingResults();
  refreshDataInBackground();
}

function handleOffline() {
  console.log('オフライン検知');
  isOnline = false;
}

function handleOfflineError() {
  const cached = loadFromCache();
  if (cached) {
    allWords = cached.words;
    allWordsForChoices = cached.words;
    userStats = cached.stats;
    recentlyTestedIds = cached.recentlyTestedIds || [];
    availableBooks = cached.availableBooks || [];
    initializeMenu();
    changeScreen('menu-screen');
    alert('通信エラー。キャッシュデータを使用します。');
  } else {
    alert('データの読み込みに失敗しました。');
  }
}

function loadPendingResults() {
  try {
    const saved = localStorage.getItem('pendingTestResults');
    if (saved) pendingTestResults = JSON.parse(saved);
  } catch (e) { console.error(e); }
}

function savePendingResults() {
  try {
    localStorage.setItem('pendingTestResults', JSON.stringify(pendingTestResults));
  } catch (e) { console.error(e); }
}

function syncPendingResults() {
  if (pendingTestResults.length === 0) return;
  console.log('保留結果同期開始:', pendingTestResults.length);
  
  let syncCount = 0;
  let totalItems = 0;
  
  // フラット化して処理
  const itemsToSync = [];
  pendingTestResults.forEach(group => {
    if(group.wordResults) itemsToSync.push(...group.wordResults);
  });
  totalItems = itemsToSync.length;
  
  if(totalItems === 0) {
    pendingTestResults = [];
    savePendingResults();
    return;
  }

  itemsToSync.forEach(item => {
    const word = allWords.find(w => w.id === item.wordId);
    if (word) {
      google.script.run
        .withSuccessHandler(() => {
          syncCount++;
          if (syncCount === totalItems) {
            console.log('全同期完了。統計更新。');
            google.script.run
              .withSuccessHandler(res => {
                if(res.success) {
                  userStats = res.stats;
                  updateDashboard();
                }
              })
              .updateWordStatisticsFromAllLog(currentBookId);
          }
        })
        .logTestResult(item.wordId, item.correct, item.direction, item.userAnswer, word.english, word.japanese, currentBookId);
    } else {
      syncCount++; // 単語が見つからない場合も進める
    }
  });
  
  pendingTestResults = [];
  savePendingResults();
}

// ===================================
// メニュー画面・ダッシュボード
// ===================================
function initializeMenu() {
  applyUISettings();
  updateBookSelectors();
  updateDashboard();
  updateWordList();
  updateEndRowInputs();
}

function updateDashboard() {
  const totalTests = userStats.totalTests || 0;
  const totalCorrect = userStats.totalCorrect || 0;
  const totalIncorrect = userStats.totalIncorrect || 0;
  const totalAnswers = totalCorrect + totalIncorrect;
  const accuracyRate = totalAnswers > 0 ? Math.round((totalCorrect / totalAnswers) * 100) : 0;
  
  document.getElementById('accuracy-rate').textContent = accuracyRate + '%';
  document.getElementById('correct-count').textContent = totalCorrect;
  document.getElementById('current-streak').textContent = userStats.currentStreak || 0;
  document.getElementById('current-level').textContent = userStats.level || 1;
  
  const currentXP = userStats.xp || 0;
  const currentLevel = userStats.level || 1;
  const xpForNextLevel = currentLevel * 100;
  const xpInCurrentLevel = currentXP - ((currentLevel - 1) * 100);
  const xpNeeded = 100;
  const progressPercent = Math.min(100, (xpInCurrentLevel / xpNeeded) * 100);
  
  document.getElementById('current-xp').textContent = xpInCurrentLevel;
  document.getElementById('next-level-xp').textContent = xpNeeded;
  document.getElementById('xp-progress').style.width = progressPercent + '%';
}

function updateWordList() {
  const learnedCount = allWords.filter(w => w.learned).length;
  const unlearnedCount = allWords.length - learnedCount;
  
  // PC
  document.getElementById('total-words').textContent = allWords.length;
  document.getElementById('learned-words').textContent = learnedCount;
  document.getElementById('unlearned-words').textContent = unlearnedCount;
  // Mobile
  document.getElementById('total-words-modal').textContent = allWords.length;
  document.getElementById('learned-words-modal').textContent = learnedCount;
  document.getElementById('unlearned-words-modal').textContent = unlearnedCount;
  
  const displayWords = getFilteredWords();
  displayWordList(displayWords);
  setupWordSearch();
}

function getFilteredWords(searchQuery = '') {
  let words = allWords;
  if (uiSettings.wordListFilter === 'mistakes') words = words.filter(w => w.incorrectCount > 0);
  else if (uiSettings.wordListFilter === 'learned') words = words.filter(w => w.learned);
  else if (uiSettings.wordListFilter === 'unlearned') words = words.filter(w => !w.learned);
  
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    const hira = toHiragana(searchQuery);
    const kata = toKatakana(searchQuery);
    words = words.filter(w => 
      String(w.id).includes(searchQuery) ||
      w.english.toLowerCase().includes(q) ||
      w.japanese.includes(searchQuery) ||
      w.japanese.includes(hira) ||
      w.japanese.includes(kata)
    );
  }
  return words;
}

function displayWordList(words) {
  const searchInput = document.querySelector('.word-search-input');
  const currentVal = searchInput ? searchInput.value : '';
  
  const html = words.map(w => `
    <div class="word-item">
      <div class="word-id">#${w.id}</div>
      <div class="word-english">${escapeHtml(w.english)}</div>
      <div class="word-japanese">${escapeHtml(w.japanese)}</div>
      ${w.learned ? '<div class="word-learned">✓ 学習済み</div>' : ''}
      ${w.incorrectCount > 0 ? `<div class="word-mistake">❌ ${w.incorrectCount}回ミス</div>` : ''}
    </div>
  `).join('');
  
  const footer = `<div class="word-list-footer">${words.length}件表示中</div>`;
  const searchBox = `
    <div class="word-search">
      <input type="text" class="word-search-input form-control" placeholder="検索..." value="${escapeHtml(currentVal)}">
    </div>`;
    
  const content = searchBox + html + footer;
  document.getElementById('word-list-sidebar').innerHTML = content;
  document.getElementById('word-list-modal').innerHTML = content;
  
  setupWordSearch();
  
  // フォーカス維持
  const newInput = document.querySelector('.word-search-input');
  if(newInput && document.activeElement.classList.contains('word-search-input')) {
    newInput.focus();
    newInput.setSelectionRange(newInput.value.length, newInput.value.length);
  }
}

function setupWordSearch() {
  const inputs = document.querySelectorAll('.word-search-input');
  inputs.forEach(input => {
    input.oninput = (e) => {
      // デバウンス簡易実装
      clearTimeout(input.timer);
      input.timer = setTimeout(() => {
        const filtered = getFilteredWords(e.target.value);
        displayWordList(filtered);
      }, 300);
    };
  });
}

function toKatakana(str) {
  return str.replace(/[\u3041-\u3096]/g, m => String.fromCharCode(m.charCodeAt(0) + 0x60));
}
function toHiragana(str) {
  return str.replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60));
}

function updateEndRowInputs() {
  const max = allWords.length;
  const endInput = document.getElementById('end-row');
  const startInput = document.getElementById('start-row');
  
  if(endInput) {
    endInput.max = max;
    endInput.value = Math.min(uiSettings.customTestRange.end || 10, max);
  }
  if(startInput) {
    startInput.value = uiSettings.customTestRange.start || 1;
  }
}

// ===================================
// モバイル用モーダル
// ===================================
document.getElementById('show-wordlist-mobile')?.addEventListener('click', () => {
  document.getElementById('wordlist-modal').classList.remove('hidden');
});
function closeWordlistModal() {
  document.getElementById('wordlist-modal').classList.add('hidden');
}

// ===================================
// テスト開始（修正版）
// ===================================
function startTest(mode) {
  testMode = mode;
  correctAnswers = 0;
  testResults = [];
  testStartTime = new Date();
  lastTestSettings.mode = mode;
  lastTestSettings.bookId = currentBookId;
  
  // ★修正: モードに応じて方向設定を取得する場所を変える
  if (mode === 'range') {
    // カスタムテストの場合
    lastTestSettings.direction = document.getElementById('mode-select').value;
    
    const s = parseInt(document.getElementById('start-row').value) || 1;
    const e = parseInt(document.getElementById('end-row').value) || 10;
    uiSettings.customTestRange = { start: s, end: e };
    saveUISettings();
    lastTestSettings.startRow = s;
    lastTestSettings.endRow = e;
    
    if (s < 1 || e > allWords.length || s > e) {
      alert('範囲指定が不正です');
      return;
    }
    currentTestWords = allWords.slice(s - 1, e);
    
  } else {
    // ★修正: 復習テスト系の場合、新しいセレクトボックスから値を取得
    lastTestSettings.direction = document.getElementById('review-mode-select').value;
    
    if (mode === 'mistakes') {
      currentTestWords = allWords.filter(w => w.incorrectCount > 0);
      if (currentTestWords.length === 0) { alert('間違えた単語がありません'); return; }
    } else if (mode === 'unlearned') {
      currentTestWords = allWords.filter(w => !w.learned);
      if (currentTestWords.length === 0) { alert('全問学習済みです'); return; }
    } else if (mode === 'all') {
      currentTestWords = allWords.filter(w => !recentlyTestedIds.includes(w.id));
      if(currentTestWords.length < 5) currentTestWords = [...allWords];
    }
  }
  
  if (currentTestWords.length === 0) { alert('対象単語がありません'); return; }
  
  currentTestWords = shuffle([...currentTestWords]);
  totalQuestions = currentTestWords.length;
  currentQuestionIndex = 0;
  
  changeScreen('test-screen');
  nextQuestion();
}

function retryTest() {
  testMode = lastTestSettings.mode;
  correctAnswers = 0;
  testResults = [];
  testStartTime = new Date();
  
  // lastTestSettingsに基づいて再構築
  if (testMode === 'range') {
    currentTestWords = allWords.slice(lastTestSettings.startRow - 1, lastTestSettings.endRow);
  } else if (testMode === 'mistakes') {
    currentTestWords = allWords.filter(w => w.incorrectCount > 0);
  } else if (testMode === 'unlearned') {
    currentTestWords = allWords.filter(w => !w.learned);
  } else {
    currentTestWords = allWords.filter(w => !recentlyTestedIds.includes(w.id));
    if(currentTestWords.length < 5) currentTestWords = [...allWords];
  }
  
  if (currentTestWords.length === 0) { alert('単語がありません'); showMenuScreen(); return; }
  
  currentTestWords = shuffle([...currentTestWords]);
  totalQuestions = currentTestWords.length;
  currentQuestionIndex = 0;
  
  changeScreen('test-screen');
  nextQuestion();
}

// ===================================
// 次の問題へ（修正版）
// ===================================
function nextQuestion() {
  if (currentQuestionIndex >= totalQuestions) {
    showEndScreen();
    return;
  }
  
  resetState();
  currentQuestionIndex++;
  currentQuestion = currentTestWords[currentQuestionIndex - 1];
  
  // ★修正: どのモードでも、保存された設定(lastTestSettings)に従って方向を決める
  if (lastTestSettings.direction === 'random') {
    questionDirection = Math.random() < 0.5 ? 'E_to_J' : 'J_to_E';
  } else {
    questionDirection = lastTestSettings.direction;
  }
  
  const qText = questionDirection === 'E_to_J' ? currentQuestion.english : currentQuestion.japanese;
  const aText = questionDirection === 'E_to_J' ? currentQuestion.japanese : currentQuestion.english;
  const lang = questionDirection === 'E_to_J' ? 'japanese' : 'english';
  
  document.getElementById('progress-text').textContent = `問題 ${currentQuestionIndex} / ${totalQuestions}`;
  document.getElementById('current-mode').textContent = questionDirection === 'E_to_J' ? '英 → 日' : '日 → 英';
  document.getElementById('question').textContent = qText;
  
  const speakBtn = document.getElementById('speak-btn');
  // 英→日の場合、または日→英で答え（英語）を表示した後など、発音ボタンの制御
  speakBtn.style.display = (questionDirection === 'E_to_J' && speechSupported) ? 'inline-block' : 'none';
  
  prepareChoices(aText, lang);
}

function prepareChoices(correct, lang) {
  const choices = new Set();
  choices.add(String(correct).trim());
  
  let attempts = 0;
  while(choices.size < 4 && attempts < 100) {
    attempts++;
    const w = allWordsForChoices[Math.floor(Math.random() * allWordsForChoices.length)];
    const val = String(lang === 'japanese' ? w.japanese : w.english).trim();
    if(val && val !== 'undefined') choices.add(val);
  }
  
  const arr = shuffle(Array.from(choices));
  const div = document.getElementById('choices');
  div.innerHTML = '';
  
  arr.forEach(c => {
    const btn = document.createElement('button');
    btn.textContent = c;
    btn.onclick = (e) => checkAnswer(c, correct, e.target);
    div.appendChild(btn);
  });
}

function showChoices() {
  document.getElementById('choices-container').classList.remove('hidden');
  document.getElementById('show-choices-btn').disabled = true;
  document.getElementById('idk-btn').disabled = false;
}

function checkAnswer(selected, correct, btn) {
  const isCorrect = String(selected).trim() === String(correct).trim();
  disableAllButtons();
  if(btn) btn.classList.add('selected');
  
  if(isCorrect) correctAnswers++;
  
  // 日英の場合、正解の英語を読み上げ
  if(questionDirection === 'J_to_E' && speechSupported) {
    speakText(currentQuestion.english, 'en-US');
  }
  
  saveResultItem(isCorrect, String(selected));
  showFeedback(isCorrect, correct);
  if(autoSaveEnabled) saveProgress();
}

function markAsIncorrect() {
  const correct = questionDirection === 'E_to_J' ? currentQuestion.japanese : currentQuestion.english;
  disableAllButtons();
  
  document.getElementById('show-choices-btn').disabled = true;
  document.getElementById('idk-btn').disabled = true;
  
  saveResultItem(false, 'わからない');
  showFeedback(false, correct);
  if(autoSaveEnabled) saveProgress();
}

function disableAllButtons() {
  document.querySelectorAll('#choices button').forEach(b => {
    b.disabled = true;
    b.style.cursor = 'not-allowed';
  });
}

function saveResultItem(isCorrect, answer) {
  const item = {
    wordId: currentQuestion.id,
    correct: isCorrect,
    direction: questionDirection,
    userAnswer: answer
  };
  testResults.push(item);
  
  if(isOnline) {
    const eng = currentQuestion.english;
    const jap = currentQuestion.japanese;
    google.script.run.logTestResult(item.wordId, isCorrect, item.direction, answer, eng, jap, currentBookId);
  }
}

function showFeedback(isCorrect, correctText) {
  const fb = document.getElementById('feedback');
  const next = document.getElementById('next-btn');
  fb.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
  fb.textContent = isCorrect ? '✓ 正解！' : `✗ 不正解。正解: ${correctText}`;
  
  next.innerHTML = currentQuestionIndex >= totalQuestions ? '結果を見る →' : '次の問題へ →';
  next.classList.remove('hidden');
}

function resetState() {
  document.getElementById('choices-container').classList.add('hidden');
  document.getElementById('choices').innerHTML = '';
  document.getElementById('feedback').className = '';
  document.getElementById('feedback').textContent = '';
  document.getElementById('next-btn').classList.add('hidden');
  document.getElementById('show-choices-btn').classList.remove('hidden');
  document.getElementById('show-choices-btn').disabled = false;
  document.getElementById('idk-btn').disabled = false;
}

// ===================================
// 進捗保存
// ===================================
function saveProgress() {
  const p = {
    testMode, currentQuestionIndex, totalQuestions, correctAnswers,
    testResults, currentTestWords, testStartTime, lastTestSettings, currentBookId
  };
  localStorage.setItem('testProgress', JSON.stringify(p));
}
function loadProgress() {
  try {
    const s = localStorage.getItem('testProgress');
    if(s) {
      const p = JSON.parse(s);
      if((new Date() - new Date(p.testStartTime)) < 86400000) return p;
    }
  } catch(e){}
  return null;
}
function clearProgress() { localStorage.removeItem('testProgress'); }
function restoreProgress() {
  const p = loadProgress();
  if(p && confirm('前回の続きから始めますか？')) {
    testMode = p.testMode;
    currentQuestionIndex = p.currentQuestionIndex;
    totalQuestions = p.totalQuestions;
    correctAnswers = p.correctAnswers;
    testResults = p.testResults;
    currentTestWords = p.currentTestWords;
    testStartTime = new Date(p.testStartTime);
    lastTestSettings = p.lastTestSettings;
    currentBookId = p.currentBookId || 'target1900';
    changeScreen('test-screen');
    nextQuestion();
    return true;
  }
  clearProgress();
  return false;
}

// ===================================
// 結果画面・終了
// ===================================
function showEndScreen() {
  changeScreen('end-screen');
  const acc = Math.round((correctAnswers / totalQuestions) * 100);
  document.getElementById('final-score').textContent = `${correctAnswers} / ${totalQuestions}`;
  document.getElementById('final-accuracy').textContent = `${acc}%`;
  document.getElementById('result-message').textContent = acc === 100 ? '完璧です！' : 'お疲れ様でした！';
  
  const data = { totalQuestions, correctAnswers, wordResults: testResults };
  
  if(!isOnline) {
    pendingTestResults.push(data);
    savePendingResults();
    document.getElementById('xp-gained').textContent = `+${correctAnswers} XP(未送信)`;
  } else {
    google.script.run
      .withSuccessHandler(res => {
        if(res.success) {
          userStats = res.stats;
          updateDashboard();
          saveToCache(allWords, res.stats, recentlyTestedIds, availableBooks);
          document.getElementById('xp-gained').textContent = `+${correctAnswers} XP`;
        }
      })
      .updateWordStatisticsFromAllLog(currentBookId);
  }
  clearProgress();
}

function changeScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function showMenuScreen() {
  const cached = loadFromCache();
  if(cached) {
    allWords = cached.words;
    userStats = cached.stats;
    initializeMenu();
    changeScreen('menu-screen');
    if(isOnline) refreshDataInBackground();
  } else {
    changeScreen('loading-screen');
    fetchWordData();
  }
}
function confirmExit() {
  if(confirm('終了してメニューに戻りますか？')) {
    saveProgress();
    showMenuScreen();
  }
}

// ===================================
// ユーティリティ
// ===================================
function shuffle(arr) {
  const newArr = [...arr];
  for(let i = newArr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
  }
  return newArr;
}
function escapeHtml(str) {
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

// ===================================
// 音声読み上げ機能（安全強化版）
// ===================================
try {
  if (speechSupported) {
    speechSynthesis.onvoiceschanged = function() {
      const voices = speechSynthesis.getVoices();
      console.log('音声リスト読み込み:', voices.length);
    };
  }
} catch (e) {
  console.error('音声初期化警告:', e);
}

function speakText(text, lang) {
  if (!lang) lang = 'en-US';
  if (!speechSupported) { console.warn('音声未対応'); return; }

  try {
    // 既存キャンセル
    speechSynthesis.cancel();

    setTimeout(() => {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      utterance.rate = 0.9;
      utterance.volume = 1.0;
      
      // 音声の選択
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        const v = voices.find(vo => vo.lang === lang && vo.name.includes('Google')) || 
                  voices.find(vo => vo.lang === lang);
        if (v) utterance.voice = v;
      }

      // ガベージコレクション対策（超重要）
      currentUtterance = utterance;
      utterance.onend = () => { currentUtterance = null; };
      utterance.onerror = (e) => { console.error('音声エラー:', e); currentUtterance = null; };
      
      speechSynthesis.speak(utterance);
    }, 50);
  } catch (e) {
    console.error('読み上げ実行エラー:', e);
  }
}

function speakQuestion() {
  if (questionDirection === 'E_to_J' && currentQuestion) {
    if (currentQuestion.english && currentQuestion.english.trim()) {
      speakText(currentQuestion.english, 'en-US');
    }
  }
}

// ===================================
// 起動時チェック
// ===================================
window.addEventListener('load', () => {
  setTimeout(() => {
    if (document.getElementById('menu-screen').classList.contains('active')) {
      restoreProgress();
    }
  }, 1000);
});
</script>