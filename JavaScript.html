<script>
// ===================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
// ===================================
let allWords = [];
let currentTestWords = [];
let currentQuestion = null;
let currentQuestionIndex = 0;
let totalQuestions = 0;
let correctAnswers = 0;
let testMode = '';
let questionDirection = '';
let allWordsForChoices = [];
let testResults = [];
let userStats = {};
let testStartTime = null;
let autoSaveEnabled = true;
let recentlyTestedIds = []; // éå»30å•ã§å‡ºé¡Œã•ã‚ŒãŸå˜èªID
let speechSynthesis = window.speechSynthesis;
let speechSupported = 'speechSynthesis' in window;
let isOnline = navigator.onLine;

// ç¾åœ¨é¸æŠä¸­ã®å˜èªå¸³
let currentBookId = 'target1900';
let availableBooks = [];

// æœ€å¾Œã®ãƒ†ã‚¹ãƒˆè¨­å®šã‚’ä¿å­˜
let lastTestSettings = {
  mode: '',
  startRow: 1,
  endRow: 10,
  direction: 'random',
  bookId: ''
};

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨UIè¨­å®š
let cachedWordData = {};  // å˜èªå¸³ã”ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
let cachedStatsData = null;
let cacheTimestamp = null;
const CACHE_DURATION = 30 * 1000; // 30ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã«å¯¾å¿œï¼‰

// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
let uiSettings = {
  fontSize: 2, // 1=small, 2=medium, 3=large, 4=xlarge
  wordListFilter: 'all', // all, mistakes, learned, unlearned
  currentBookId: 'target1900', // ç¾åœ¨é¸æŠä¸­ã®å˜èªå¸³
  customTestRange: { // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆã®ç¯„å›²ã‚’ä¿å­˜
    start: 1,
    end: 10
  }
};

// ===================================
// åˆæœŸåŒ–
// ===================================
window.onload = function() {
  console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
  
  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  
  // UIè¨­å®šã‚’èª­ã¿è¾¼ã¿
  loadUISettings();
  
  // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ä¿ç•™çµæœã‚’èª­ã¿è¾¼ã¿
  loadPendingResults();
  
  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å³åº§ã«é©ç”¨
  const fontSizeClasses = ['font-small', 'font-medium', 'font-large', 'font-xlarge'];
  document.body.classList.remove(...fontSizeClasses);
  const fontSizeClass = fontSizeClasses[uiSettings.fontSize - 1] || 'font-medium';
  document.body.classList.add(fontSizeClass);
  console.log('åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºé©ç”¨:', fontSizeClass);
  
  // ç¾åœ¨ã®å˜èªå¸³IDã‚’å¾©å…ƒ
  currentBookId = uiSettings.currentBookId || 'target1900';
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  loadWordData();
};

// ===================================
// UIè¨­å®šã®ç®¡ç†
// ===================================
function loadUISettings() {
  try {
    const saved = localStorage.getItem('uiSettings');
    if (saved) {
      const loadedSettings = JSON.parse(saved);
      // å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã®äº’æ›æ€§ã‚’ä¿ã¤
      uiSettings = {
        ...uiSettings,
        ...loadedSettings
      };
      
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆã®ç¯„å›²ã‚’å¾©å…ƒ
      if (uiSettings.customTestRange) {
        document.getElementById('start-row').value = uiSettings.customTestRange.start;
        document.getElementById('end-row').value = uiSettings.customTestRange.end;
      }
      
      console.log('UIè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', uiSettings);
    }
  } catch (e) {
    console.error('UIè¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function saveUISettings() {
  try {
    localStorage.setItem('uiSettings', JSON.stringify(uiSettings));
    console.log('UIè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', uiSettings);
  } catch (e) {
    console.error('UIè¨­å®šã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function applyUISettings() {
  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã®é©ç”¨
  const fontSizeClasses = ['font-small', 'font-medium', 'font-large', 'font-xlarge'];
  document.body.classList.remove(...fontSizeClasses);
  
  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
  const fontSizeClass = fontSizeClasses[uiSettings.fontSize - 1] || 'font-medium';
  document.body.classList.add(fontSizeClass);
  
  console.log('ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚¯ãƒ©ã‚¹ã‚’é©ç”¨:', fontSizeClass);
  
  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ä½ç½®ã‚’è¨­å®š
  const slider = document.getElementById('font-size-slider');
  if (slider) {
    slider.value = uiSettings.fontSize;
    updateFontPreview();
  }
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
  updateFilterButtons();
}

function toggleSettings() {
  const panel = document.getElementById('settings-panel');
  panel.classList.toggle('hidden');
}

// ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener('DOMContentLoaded', function() {
  const slider = document.getElementById('font-size-slider');
  if (slider) {
    slider.addEventListener('input', function(e) {
      uiSettings.fontSize = parseInt(e.target.value);
      applyUISettings();
      saveUISettings();
    });
  }
});

function updateFontPreview() {
  const preview = document.getElementById('font-preview');
  if (preview) {
    const sizeNames = ['å°ã•ã‚', 'æ¨™æº–', 'å¤§ãã‚', 'ç‰¹å¤§'];
    preview.textContent = `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (${sizeNames[uiSettings.fontSize - 1]}): ã“ã‚ŒãŒã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã§ã™`;
  }
}

// ===================================
// å˜èªå¸³åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
// ===================================
function switchBook(bookId) {
  console.log('å˜èªå¸³ã‚’åˆ‡ã‚Šæ›¿ãˆ:', bookId);
  currentBookId = bookId;
  uiSettings.currentBookId = bookId;
  saveUISettings();
  
  // è©²å½“ã™ã‚‹å˜èªå¸³ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  loadWordData();
}

function updateBookSelectors() {
  // PCç‰ˆã¨ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ä¸¡æ–¹ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æ›´æ–°
  const selectors = [
    document.getElementById('book-selector'),
    document.getElementById('book-selector-modal')
  ];
  
  selectors.forEach(selector => {
    if (selector) {
      selector.innerHTML = '';
      availableBooks.forEach(book => {
        const option = document.createElement('option');
        option.value = book.id;
        option.textContent = book.name;
        if (book.id === currentBookId) {
          option.selected = true;
        }
        selector.appendChild(option);
      });
    }
  });
  
  // ç¾åœ¨ã®å˜èªå¸³åã‚’è¡¨ç¤º
  const currentBook = availableBooks.find(b => b.id === currentBookId);
  if (currentBook) {
    const nameElements = [
      document.getElementById('current-book-name'),
      document.getElementById('current-book-display-name'),
      document.getElementById('modal-book-name')
    ];
    
    nameElements.forEach(el => {
      if (el) el.textContent = currentBook.name;
    });
  }
}

// ===================================
// å˜èªå¸³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
// ===================================
function setWordFilter(filter) {
  console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰æ›´:', filter);
  uiSettings.wordListFilter = filter;
  saveUISettings();
  updateFilterButtons();
  
  // æ¤œç´¢å€¤ã‚’ã‚¯ãƒªã‚¢
  const searchInputs = document.querySelectorAll('#word-search-input');
  searchInputs.forEach(input => {
    input.value = '';
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã¦å˜èªãƒªã‚¹ãƒˆã‚’æ›´æ–°
  const filteredWords = getFilteredWords();
  displayWordList(filteredWords);
  
  console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œã®å˜èªæ•°:', filteredWords.length);
}

function updateFilterButtons() {
  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
  const selectElements = [
    document.getElementById('word-filter-select'),
    document.getElementById('word-filter-select-modal')
  ];
  
  selectElements.forEach(select => {
    if (select) {
      select.value = uiSettings.wordListFilter;
    }
  });
}

// ===================================
// ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
// ===================================
function loadWordData() {
  updateLoadingMessage('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªä¸­...');
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
  const cached = loadFromCache();
  if (cached) {
    console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    updateLoadingMessage('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿å®Œäº†', 'å³åº§ã«èµ·å‹•ã—ã¾ã™');
    
    allWords = cached.words;
    allWordsForChoices = cached.words;
    userStats = cached.stats;
    recentlyTestedIds = cached.recentlyTestedIds || [];
    availableBooks = cached.availableBooks || [];
    
    // çŸ­ã„é…å»¶å¾Œã«ç”»é¢é·ç§»ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
    setTimeout(() => {
      initializeMenu();
      changeScreen('menu-screen');
    }, 100);
    
    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ç”¨ï¼‰
    refreshDataInBackground();
    return;
  }
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯é€šå¸¸é€šã‚Šèª­ã¿è¾¼ã¿
  updateLoadingMessage('ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...', 'åˆå›èµ·å‹•ã®ãŸã‚å°‘ã—ãŠå¾…ã¡ãã ã•ã„');
  fetchWordData();
}

function updateLoadingMessage(main, detail = '') {
  const mainEl = document.getElementById('loading-message');
  const detailEl = document.getElementById('loading-detail');
  
  if (mainEl) mainEl.textContent = main;
  if (detailEl) detailEl.textContent = detail;
}

function fetchWordData() {
  if (!isOnline) {
    console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
    updateLoadingMessage('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰', 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­');
    
    const cached = loadFromCache();
    if (cached) {
      allWords = cached.words;
      allWordsForChoices = cached.words;
      userStats = cached.stats;
      recentlyTestedIds = cached.recentlyTestedIds || [];
      availableBooks = cached.availableBooks || [];
      initializeMenu();
      changeScreen('menu-screen');
    } else {
      alert('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
    }
    return;
  }
  
  updateLoadingMessage('ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ä¸­...', 'å˜èªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™');
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        updateLoadingMessage('ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...', 'å˜èªãƒªã‚¹ãƒˆã‚’æº–å‚™ã—ã¦ã„ã¾ã™');
        
        allWords = response.words;
        allWordsForChoices = response.words;
        userStats = response.stats;
        recentlyTestedIds = response.recentlyTestedIds || [];
        availableBooks = response.availableBooks || [];
        
        // ç¾åœ¨ã®å˜èªå¸³æƒ…å ±ã‚’ç¢ºèª
        if (response.bookInfo) {
          currentBookId = response.bookInfo.id;
          uiSettings.currentBookId = currentBookId;
          saveUISettings();
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        saveToCache(response.words, response.stats, response.recentlyTestedIds, response.availableBooks);
        
        console.log('èª­ã¿è¾¼ã‚“ã å˜èªæ•°:', allWords.length);
        console.log('åˆ©ç”¨å¯èƒ½ãªå˜èªå¸³:', availableBooks);
        console.log('ç¾åœ¨ã®å˜èªå¸³:', currentBookId);
        console.log('ä¸æ­£è§£ã®ã‚ã‚‹å˜èª:', allWords.filter(w => w.incorrectCount > 0).length);
        console.log('éå»30å•ã§å‡ºé¡Œã•ã‚ŒãŸå˜èªæ•°:', recentlyTestedIds.length);
        
        updateLoadingMessage('å®Œäº†ï¼', 'èµ·å‹•ã—ã¦ã„ã¾ã™');
        
        setTimeout(() => {
          initializeMenu();
          changeScreen('menu-screen');
        }, 200);
      } else {
        alert(response.message || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        changeScreen('menu-screen');
      }
    })
    .withFailureHandler(function(error) {
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      updateLoadingMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
      setTimeout(() => {
        handleOfflineError();
      }, 1000);
    })
    .getWordLists(currentBookId);
}

function refreshDataInBackground() {
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
        saveToCache(response.words, response.stats, response.recentlyTestedIds, response.availableBooks);
        // ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
        allWords = response.words;
        allWordsForChoices = response.words;
        userStats = response.stats;
        recentlyTestedIds = response.recentlyTestedIds || [];
        availableBooks = response.availableBooks || [];
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
        updateDashboard();
        console.log('ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      }
    })
    .withFailureHandler(function(error) {
      console.log('ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ã—ã¾ã™ï¼‰:', error);
    })
    .getWordLists(currentBookId);
}

function saveToCache(words, stats, recentlyTested = [], books = []) {
  try {
    // å˜èªå¸³ã”ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
    cachedWordData[currentBookId] = {
      words: words,
      stats: stats,
      recentlyTestedIds: recentlyTested,
      availableBooks: books,
      timestamp: Date.now()
    };
    
    localStorage.setItem('wordDataCache_' + currentBookId, JSON.stringify(cachedWordData[currentBookId]));
    console.log('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã—ã¾ã—ãŸ:', currentBookId);
  } catch (e) {
    console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function loadFromCache() {
  try {
    const cached = localStorage.getItem('wordDataCache_' + currentBookId);
    if (!cached) return null;
    
    const cacheData = JSON.parse(cached);
    const age = Date.now() - cacheData.timestamp;
    
    if (age < CACHE_DURATION) {
      return {
        words: cacheData.words,
        stats: cacheData.stats,
        recentlyTestedIds: cacheData.recentlyTestedIds || [],
        availableBooks: cacheData.availableBooks || []
      };
    } else {
      console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„ãŸã‚ç„¡è¦–ã—ã¾ã™');
      return null;
    }
  } catch (e) {
    console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    return null;
  }
}

function clearCache() {
  try {
    // ã™ã¹ã¦ã®å˜èªå¸³ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    availableBooks.forEach(book => {
      localStorage.removeItem('wordDataCache_' + book.id);
    });
    console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  } catch (e) {
    console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', e);
  }
}

// ===================================
// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
// ===================================
function handleOnline() {
  console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ');
  isOnline = true;
  
  // ä¿ç•™ä¸­ã®çµæœã‚’åŒæœŸ
  syncPendingResults();
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«æ›´æ–°
  fetchWordData();
}

function handleOffline() {
  console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸ');
  isOnline = false;
}

function handleOfflineError() {
  const cached = loadFromCache();
  if (cached) {
    console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
    allWords = cached.words;
    allWordsForChoices = cached.words;
    userStats = cached.stats;
    recentlyTestedIds = cached.recentlyTestedIds || [];
    availableBooks = cached.availableBooks || [];
    initializeMenu();
    changeScreen('menu-screen');
    alert('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
  } else {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚');
  }
}

function loadPendingResults() {
  try {
    const saved = localStorage.getItem('pendingTestResults');
    if (saved) {
      pendingTestResults = JSON.parse(saved);
      console.log('ä¿ç•™ä¸­ã®çµæœã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', pendingTestResults.length);
    }
  } catch (e) {
    console.error('ä¿ç•™çµæœã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function savePendingResults() {
  try {
    localStorage.setItem('pendingTestResults', JSON.stringify(pendingTestResults));
    console.log('ä¿ç•™ä¸­ã®çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  } catch (e) {
    console.error('ä¿ç•™çµæœã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function syncPendingResults() {
  if (pendingTestResults.length === 0) {
    return;
  }
  
  console.log('ä¿ç•™ä¸­ã®çµæœã‚’åŒæœŸä¸­:', pendingTestResults.length);
  
  // ä¿ç•™ä¸­ã®ãƒ†ã‚¹ãƒˆçµæœã‹ã‚‰å„å•é¡Œã‚’å€‹åˆ¥ã«é€ä¿¡
  let syncCount = 0;
  let totalItems = 0;
  
  pendingTestResults.forEach(testResult => {
    if (testResult.wordResults && testResult.wordResults.length > 0) {
      testResult.wordResults.forEach(item => {
        totalItems++;
        
        // å˜èªæƒ…å ±ã‚’å–å¾—
        const word = allWords.find(w => w.id === item.wordId);
        if (word) {
          google.script.run
            .withSuccessHandler(function(response) {
              syncCount++;
              console.log(`ä¿ç•™çµæœã‚’åŒæœŸ (${syncCount}/${totalItems})`);
              
              // ã™ã¹ã¦åŒæœŸå®Œäº†ã—ãŸã‚‰çµ±è¨ˆã‚’æ›´æ–°
              if (syncCount === totalItems) {
                console.log('ã™ã¹ã¦ã®ä¿ç•™çµæœã‚’åŒæœŸå®Œäº†ã€‚çµ±è¨ˆã‚’æ›´æ–°ã—ã¾ã™');
                google.script.run
                  .withSuccessHandler(function(response) {
                    if (response.success) {
                      userStats = response.stats;
                      updateDashboard();
                      console.log('çµ±è¨ˆæ›´æ–°å®Œäº†');
                    }
                  })
                  .updateWordStatisticsFromAllLog(currentBookId);
              }
            })
            .withFailureHandler(function(error) {
              console.error('ä¿ç•™çµæœã®åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
            })
            .logTestResult(item.wordId, item.correct, item.direction, item.userAnswer, word.english, word.japanese, currentBookId);
        }
      });
    }
  });
  
  // åŒæœŸå¾Œã€ä¿ç•™ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
  pendingTestResults = [];
  savePendingResults();
}

// ===================================
// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã®åˆæœŸåŒ–
// ===================================
function initializeMenu() {
  console.log('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’åˆæœŸåŒ–');
  
  // UIè¨­å®šã‚’é©ç”¨ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãªã©ã®DOMè¦ç´ ãŒå­˜åœ¨ã™ã‚‹ï¼‰
  applyUISettings();
  
  // å˜èªå¸³ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æ›´æ–°
  updateBookSelectors();
  
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨å˜èªãƒªã‚¹ãƒˆã‚’æ›´æ–°
  updateDashboard();
  updateWordList();
  updateEndRowInputs();
}

function updateDashboard() {
  const totalTests = userStats.totalTests || 0;
  const totalCorrect = userStats.totalCorrect || 0;
  const totalIncorrect = userStats.totalIncorrect || 0;
  const totalAnswers = totalCorrect + totalIncorrect;
  const accuracyRate = totalAnswers > 0 ? Math.round((totalCorrect / totalAnswers) * 100) : 0;
  
  document.getElementById('accuracy-rate').textContent = accuracyRate + '%';
  document.getElementById('correct-count').textContent = totalCorrect;
  document.getElementById('current-streak').textContent = userStats.currentStreak || 0;
  document.getElementById('current-level').textContent = userStats.level || 1;
  
  // ãƒ¬ãƒ™ãƒ«ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
  const currentXP = userStats.xp || 0;
  const currentLevel = userStats.level || 1;
  const xpForCurrentLevel = (currentLevel - 1) * 100;
  const xpForNextLevel = currentLevel * 100;
  const xpInCurrentLevel = currentXP - xpForCurrentLevel;
  const xpNeededForNextLevel = xpForNextLevel - xpForCurrentLevel;
  const progressPercent = (xpInCurrentLevel / xpNeededForNextLevel) * 100;
  
  document.getElementById('current-xp').textContent = xpInCurrentLevel;
  document.getElementById('next-level-xp').textContent = xpNeededForNextLevel;
  document.getElementById('xp-progress').style.width = progressPercent + '%';
}

function updateWordList() {
  const learnedCount = allWords.filter(w => w.learned).length;
  const unlearnedCount = allWords.length - learnedCount;
  const actualWordCount = allWords.length;
  
  // PCç”¨ã‚µã‚¤ãƒ‰ãƒãƒ¼
  document.getElementById('total-words').textContent = actualWordCount;
  document.getElementById('learned-words').textContent = learnedCount;
  document.getElementById('unlearned-words').textContent = unlearnedCount;
  
  // ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('total-words-modal').textContent = actualWordCount;
  document.getElementById('learned-words-modal').textContent = learnedCount;
  document.getElementById('unlearned-words-modal').textContent = unlearnedCount;
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«åŸºã¥ã„ã¦å˜èªã‚’çµã‚Šè¾¼ã¿
  let displayWords = getFilteredWords();
  
  // å˜èªãƒªã‚¹ãƒˆã®è¡¨ç¤º
  displayWordList(displayWords);
  
  // æ¤œç´¢æ©Ÿèƒ½ã®è¿½åŠ 
  setupWordSearch();
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚ŒãŸå˜èªãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getFilteredWords(searchQuery = '') {
  let words = allWords;
  
  // ã¾ãšãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
  if (uiSettings.wordListFilter === 'mistakes') {
    words = words.filter(w => w.incorrectCount > 0);
  } else if (uiSettings.wordListFilter === 'learned') {
    words = words.filter(w => w.learned);
  } else if (uiSettings.wordListFilter === 'unlearned') {
    words = words.filter(w => !w.learned);
  }
  // 'all'ã®å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãªã„
  
  // æ¬¡ã«æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’é©ç”¨
  if (searchQuery) {
    const queryLower = searchQuery.toLowerCase();
    const hiraganaQuery = toHiragana(searchQuery);
    const katakanaQuery = toKatakana(searchQuery);
    
    words = words.filter(word => {
      const idMatch = String(word.id).includes(searchQuery);
      const englishMatch = word.english.toLowerCase().includes(queryLower);
      const japaneseMatch = word.japanese.includes(searchQuery);
      const hiraganaMatch = word.japanese.includes(hiraganaQuery);
      const katakanaMatch = word.japanese.includes(katakanaQuery);
      
      return idMatch || englishMatch || japaneseMatch || hiraganaMatch || katakanaMatch;
    });
  }
  
  return words;
}

function displayWordList(words) {
  // ç¾åœ¨ã®æ¤œç´¢å€¤ã¨ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ä¿å­˜
  const currentSearchInput = document.getElementById('word-search-input');
  const currentSearchValue = currentSearchInput?.value || '';
  const currentSelectionStart = currentSearchInput?.selectionStart || 0;
  const currentSelectionEnd = currentSearchInput?.selectionEnd || 0;
  
  const wordListHTML = words.map(word => {
    const mistakeInfo = word.incorrectCount > 0 
      ? `<div class="word-mistake">âŒ ${word.incorrectCount}å›ãƒŸã‚¹</div>` 
      : '';
    
    return `
      <div class="word-item">
        <div class="word-id">#${word.id}</div>
        <div class="word-english">${escapeHtml(word.english)}</div>
        <div class="word-japanese">${escapeHtml(word.japanese)}</div>
        ${word.learned ? '<div class="word-learned">âœ“ å­¦ç¿’æ¸ˆã¿</div>' : ''}
        ${mistakeInfo}
      </div>
    `;
  }).join('');
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
  const mistakesCount = allWords.filter(w => w.incorrectCount > 0).length;
  let filterInfo = '';
  if (uiSettings.wordListFilter === 'mistakes') {
    filterInfo = `é–“é•ã£ãŸå˜èª ${words.length} / ${mistakesCount} ä»¶ã‚’è¡¨ç¤ºä¸­`;
  } else {
    filterInfo = `å…¨ ${words.length} / ${allWords.length} ä»¶ã‚’è¡¨ç¤ºä¸­`;
  }
  
  const footerHTML = `<div class="word-list-footer">${filterInfo}</div>`;
  
  const searchHTML = `
    <div class="word-search">
      <input type="text" id="word-search-input" class="word-search-input" placeholder="ğŸ” å˜èªã‚’æ¤œç´¢ï¼ˆè‹±èªãƒ»æ—¥æœ¬èªãƒ»ç•ªå·ï¼‰..." value="${escapeHtml(currentSearchValue)}">
    </div>
  `;
  
  document.getElementById('word-list-sidebar').innerHTML = searchHTML + wordListHTML + footerHTML;
  document.getElementById('word-list-modal').innerHTML = searchHTML + wordListHTML + footerHTML;
  
  // æ¤œç´¢æ©Ÿèƒ½ã‚’å†è¨­å®š
  setupWordSearch();
  
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¨ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ç¢ºå®Ÿã«å¾©å…ƒ
  const searchInput = document.getElementById('word-search-input');
  if (searchInput) {
    // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®Ÿè¡Œã—ã¦ã€ç¢ºå®Ÿã«DOMæ›´æ–°å¾Œã«å‡¦ç†
    requestAnimationFrame(() => {
      searchInput.focus();
      searchInput.setSelectionRange(currentSelectionStart, currentSelectionEnd);
    });
  }
}

function setupWordSearch() {
  const searchInputs = document.querySelectorAll('#word-search-input');
  
  searchInputs.forEach(input => {
    let isComposing = false;
    let searchTimeout = null;
    
    // IMEå¤‰æ›é–‹å§‹æ™‚
    input.addEventListener('compositionstart', function() {
      isComposing = true;
    });
    
    // IMEå¤‰æ›çµ‚äº†æ™‚
    input.addEventListener('compositionend', function(e) {
      isComposing = false;
      // å¤‰æ›ç¢ºå®šå¾Œã«æ¤œç´¢ã‚’å®Ÿè¡Œ
      const query = e.target.value.trim();
      console.log('æ¤œç´¢ã‚¯ã‚¨ãƒªï¼ˆå¤‰æ›ç¢ºå®šï¼‰:', query);
      console.log('ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:', uiSettings.wordListFilter);
      
      const filtered = getFilteredWords(query);
      console.log('æ¤œç´¢çµæœ:', filtered.length, 'ä»¶');
      displayWordList(filtered);
    });
    
    input.addEventListener('input', function(e) {
      // IMEå¤‰æ›ä¸­ã¯æ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (isComposing) {
        return;
      }
      
      // å‰ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // 200mså¾Œã«æ¤œç´¢ã‚’å®Ÿè¡Œï¼ˆå…¥åŠ›ãŒè½ã¡ç€ã„ã¦ã‹ã‚‰ï¼‰
      searchTimeout = setTimeout(() => {
        const query = e.target.value.trim();
        
        console.log('æ¤œç´¢ã‚¯ã‚¨ãƒª:', query);
        console.log('ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:', uiSettings.wordListFilter);
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨æ¤œç´¢ã®ä¸¡æ–¹ã‚’é©ç”¨
        const filtered = getFilteredWords(query);
        
        console.log('æ¤œç´¢çµæœ:', filtered.length, 'ä»¶');
        displayWordList(filtered);
      }, 200);
    });
  });
}

// ã²ã‚‰ãŒãªã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›
function toKatakana(str) {
  return str.replace(/[\u3041-\u3096]/g, function(match) {
    const chr = match.charCodeAt(0) + 0x60;
    return String.fromCharCode(chr);
  });
}

// ã‚«ã‚¿ã‚«ãƒŠã‚’ã²ã‚‰ãŒãªã«å¤‰æ›
function toHiragana(str) {
  return str.replace(/[\u30a1-\u30f6]/g, function(match) {
    const chr = match.charCodeAt(0) - 0x60;
    return String.fromCharCode(chr);
  });
}

function updateEndRowInputs() {
  const maxRow = allWords.length;
  
  // ä¿å­˜ã•ã‚ŒãŸç¯„å›²ã‚’é©ç”¨ã€ä¸Šé™ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯èª¿æ•´
  const savedEnd = uiSettings.customTestRange?.end || 10;
  const endValue = Math.min(savedEnd, maxRow);
  
  document.getElementById('end-row').value = endValue;
  document.getElementById('end-row').max = maxRow;
  
  // é–‹å§‹ç•ªå·ã‚‚ä¿å­˜ã•ã‚ŒãŸå€¤ã‚’é©ç”¨
  if (uiSettings.customTestRange?.start) {
    document.getElementById('start-row').value = uiSettings.customTestRange.start;
  }
}

// ===================================
// ãƒ¢ãƒã‚¤ãƒ«ç”¨å˜èªå¸³ãƒ¢ãƒ¼ãƒ€ãƒ«
// ===================================
document.getElementById('show-wordlist-mobile')?.addEventListener('click', function() {
  document.getElementById('wordlist-modal').classList.remove('hidden');
});

function closeWordlistModal() {
  document.getElementById('wordlist-modal').classList.add('hidden');
}

document.getElementById('wordlist-modal')?.addEventListener('click', function(e) {
  if (e.target === this) {
    closeWordlistModal();
  }
});

// ===================================
// ãƒ†ã‚¹ãƒˆé–‹å§‹
// ===================================
function startTest(mode) {
  testMode = mode;
  correctAnswers = 0;
  testResults = [];
  testStartTime = new Date();
  
  // ãƒ†ã‚¹ãƒˆè¨­å®šã‚’ä¿å­˜
  lastTestSettings.mode = mode;
  lastTestSettings.bookId = currentBookId;
  
  // ãƒ†ã‚¹ãƒˆç”¨ã®å˜èªãƒªã‚¹ãƒˆã‚’æº–å‚™
  if (mode === 'range') {
    const startRow = parseInt(document.getElementById('start-row').value) || 1;
    const endRow = parseInt(document.getElementById('end-row').value) || 10;
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆã®ç¯„å›²ã‚’ä¿å­˜
    uiSettings.customTestRange = {
      start: startRow,
      end: endRow
    };
    saveUISettings();
    
    lastTestSettings.startRow = startRow;
    lastTestSettings.endRow = endRow;
    lastTestSettings.direction = document.getElementById('mode-select').value;
    
    // å…¥åŠ›å€¤ã®æ¤œè¨¼
    if (isNaN(startRow) || isNaN(endRow)) {
      alert('é–‹å§‹è¡Œã¨çµ‚äº†è¡Œã«ã¯æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    if (startRow < 1 || endRow > allWords.length || startRow > endRow) {
      alert(`ç¯„å›²æŒ‡å®šãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\n\næœ‰åŠ¹ãªç¯„å›²: 1ã€œ${allWords.length}\né–‹å§‹è¡Œã¯çµ‚äº†è¡Œä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`);
      return;
    }
    
    currentTestWords = allWords.slice(startRow - 1, endRow);
    console.log(`ç¯„å›²ãƒ†ã‚¹ãƒˆ: ${startRow}ã€œ${endRow} (${currentTestWords.length}å•)`);
  } else if (mode === 'mistakes') {
    // ä¸æ­£è§£ã®ã‚ã‚‹å˜èªã®ã¿
    currentTestWords = allWords.filter(word => word.incorrectCount > 0);
    
    console.log('ãƒŸã‚¹ãƒ†ã‚¹ãƒˆ: å¯¾è±¡å˜èªæ•° =', currentTestWords.length);
    console.log('å˜èªä¾‹:', currentTestWords.slice(0, 3));
    
    if (currentTestWords.length === 0) {
      alert('é–“é•ãˆãŸå˜èªãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚\n\né€šå¸¸ã®ãƒ†ã‚¹ãƒˆã§é–“é•ãˆã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚');
      return;
    }
  } else if (mode === 'unlearned') {
    currentTestWords = allWords.filter(word => !word.learned);
    
    if (currentTestWords.length === 0) {
      alert('ã™ã¹ã¦ã®å˜èªãŒå­¦ç¿’æ¸ˆã¿ã§ã™ï¼\n\nç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼');
      return;
    }
  } else if (mode === 'all') {
    // éå»30å•ã§å‡ºé¡Œã•ã‚ŒãŸå˜èªã‚’é™¤å¤–
    currentTestWords = allWords.filter(word => !recentlyTestedIds.includes(word.id));
    
    // é™¤å¤–å¾Œã‚‚å˜èªãŒå°‘ãªã„å ´åˆã¯å…¨å˜èªã‚’ä½¿ç”¨
    if (currentTestWords.length < 5) {
      console.log('é™¤å¤–å¾Œã®å˜èªãŒå°‘ãªã„ãŸã‚ã€å…¨å˜èªã‚’ä½¿ç”¨ã—ã¾ã™');
      currentTestWords = [...allWords];
    } else {
      console.log(`éå»30å•ã§å‡ºé¡Œã•ã‚ŒãŸ${recentlyTestedIds.length}å€‹ã®å˜èªã‚’é™¤å¤–ã—ã¾ã—ãŸ`);
    }
  }
  
  if (currentTestWords.length === 0) {
    alert('ãƒ†ã‚¹ãƒˆã§ãã‚‹å˜èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
    return;
  }
  
  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  currentTestWords = shuffle([...currentTestWords]);
  totalQuestions = currentTestWords.length;
  currentQuestionIndex = 0;
  
  console.log(`ãƒ†ã‚¹ãƒˆé–‹å§‹: ${totalQuestions}å•`);
  console.log('ãƒ†ã‚¹ãƒˆè¨­å®šã‚’ä¿å­˜:', lastTestSettings);
  
  changeScreen('test-screen');
  nextQuestion();
}

// ===================================
// ã‚‚ã†ä¸€å›å­¦ç¿’æ©Ÿèƒ½
// ===================================
function retryTest() {
  console.log('ã‚‚ã†ä¸€å›å­¦ç¿’ã‚’é–‹å§‹:', lastTestSettings);
  
  // æœ€å¾Œã®ãƒ†ã‚¹ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å†é–‹
  testMode = lastTestSettings.mode;
  correctAnswers = 0;
  testResults = [];
  testStartTime = new Date();
  
  // ãƒ†ã‚¹ãƒˆç”¨ã®å˜èªãƒªã‚¹ãƒˆã‚’æº–å‚™
  if (lastTestSettings.mode === 'range') {
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆã®è¨­å®šã‚’å¾©å…ƒ
    document.getElementById('start-row').value = lastTestSettings.startRow;
    document.getElementById('end-row').value = lastTestSettings.endRow;
    document.getElementById('mode-select').value = lastTestSettings.direction;
    
    currentTestWords = allWords.slice(lastTestSettings.startRow - 1, lastTestSettings.endRow);
  } else if (lastTestSettings.mode === 'mistakes') {
    currentTestWords = allWords.filter(word => word.incorrectCount > 0);
    
    if (currentTestWords.length === 0) {
      alert('é–“é•ãˆãŸå˜èªãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚');
      showMenuScreen();
      return;
    }
  } else if (lastTestSettings.mode === 'unlearned') {
    currentTestWords = allWords.filter(word => !word.learned);
    
    if (currentTestWords.length === 0) {
      alert('ã™ã¹ã¦ã®å˜èªãŒå­¦ç¿’æ¸ˆã¿ã§ã™ï¼');
      showMenuScreen();
      return;
    }
  } else if (lastTestSettings.mode === 'all') {
    currentTestWords = allWords.filter(word => !recentlyTestedIds.includes(word.id));
    
    if (currentTestWords.length < 5) {
      currentTestWords = [...allWords];
    }
  }
  
  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  currentTestWords = shuffle([...currentTestWords]);
  totalQuestions = currentTestWords.length;
  currentQuestionIndex = 0;
  
  console.log(`ã‚‚ã†ä¸€å›å­¦ç¿’: ${totalQuestions}å•`);
  
  changeScreen('test-screen');
  nextQuestion();
}

// ===================================
// ãƒ†ã‚¹ãƒˆç”»é¢ã®æ“ä½œ
// ===================================
function nextQuestion() {
  if (currentQuestionIndex >= totalQuestions) {
    showEndScreen();
    return;
  }
  
  resetState();
  currentQuestionIndex++;
  currentQuestion = currentTestWords[currentQuestionIndex - 1];
  questionDirection = determineQuestionDirection();
  
  let questionText = '', correctAnswer = '', answerLanguage = '';
  if (questionDirection === 'E_to_J') {
    questionText = currentQuestion.english;
    correctAnswer = currentQuestion.japanese;
    answerLanguage = 'japanese';
  } else {
    questionText = currentQuestion.japanese;
    correctAnswer = currentQuestion.english;
    answerLanguage = 'english';
  }
  
  document.getElementById('progress-text').textContent = `å•é¡Œ ${currentQuestionIndex} / ${totalQuestions}`;
  document.getElementById('current-mode').textContent = getModeName(questionDirection);
  document.getElementById('question').textContent = questionText;
  
  // è‹±â†’æ—¥ã®å ´åˆã€ç™ºéŸ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  const speakBtn = document.getElementById('speak-btn');
  if (questionDirection === 'E_to_J' && speechSupported) {
    speakBtn.style.display = 'inline-block';
  } else {
    speakBtn.style.display = 'none';
  }
  
  // é¸æŠè‚¢ã‚’äº‹å‰ç”Ÿæˆ
  prepareChoices(correctAnswer, answerLanguage);
}

function determineQuestionDirection() {
  const mode = lastTestSettings.mode === 'range' 
    ? lastTestSettings.direction 
    : document.getElementById('mode-select').value;
    
  if (mode === 'E_to_J') return 'E_to_J';
  if (mode === 'J_to_E') return 'J_to_E';
  return Math.random() < 0.5 ? 'E_to_J' : 'J_to_E';
}

function getModeName(direction) {
  return direction === 'E_to_J' ? 'è‹±èª â†’ æ—¥æœ¬èª' : 'æ—¥æœ¬èª â†’ è‹±èª';
}

function prepareChoices(correctAnswer, answerLanguage) {
  const incorrectAnswers = new Set();
  const maxAttempts = allWordsForChoices.length * 3;
  let attempts = 0;
  
  console.log('=== é¸æŠè‚¢ç”Ÿæˆé–‹å§‹ ===');
  console.log('æ­£è§£:', correctAnswer, 'ã‚¿ã‚¤ãƒ—:', typeof correctAnswer);
  console.log('è¨€èª:', answerLanguage);
  
  // æ­£è§£ã¨ç•°ãªã‚‹å˜èªã‚’3ã¤é¸æŠ
  while (incorrectAnswers.size < 3 && attempts < maxAttempts) {
    attempts++;
    const randomWord = allWordsForChoices[Math.floor(Math.random() * allWordsForChoices.length)];
    
    let potentialAnswer = answerLanguage === 'japanese' ? randomWord.japanese : randomWord.english;
    
    if (attempts <= 5) {
      console.log(`è©¦è¡Œ ${attempts}:`, potentialAnswer, 'ã‚¿ã‚¤ãƒ—:', typeof potentialAnswer);
    }
    
    potentialAnswer = String(potentialAnswer).trim();
    
    if (potentialAnswer && 
        potentialAnswer !== String(correctAnswer).trim() && 
        potentialAnswer !== '' &&
        potentialAnswer !== 'undefined' &&
        potentialAnswer !== 'null') {
      incorrectAnswers.add(potentialAnswer);
    }
  }
  
  console.log('ä¸æ­£è§£ã®é¸æŠè‚¢:', Array.from(incorrectAnswers));
  console.log('è©¦è¡Œå›æ•°:', attempts);
  
  if (incorrectAnswers.size < 3) {
    console.warn('âš ï¸ é¸æŠè‚¢ãŒä¸è¶³:', incorrectAnswers.size, 'å€‹');
  }
  
  const options = shuffle([String(correctAnswer).trim(), ...Array.from(incorrectAnswers)]);
  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = '';
  
  console.log('æœ€çµ‚çš„ãªé¸æŠè‚¢:', options);
  
  options.forEach(option => {
    const button = document.createElement('button');
    button.textContent = option;
    button.onclick = (e) => checkAnswer(option, correctAnswer, e.target);
    choicesDiv.appendChild(button);
  });
  
  console.log('=== é¸æŠè‚¢ç”Ÿæˆå®Œäº† ===');
}

function showChoices() {
  document.getElementById('choices-container').classList.remove('hidden');
  document.getElementById('show-choices-btn').disabled = true;
  document.getElementById('idk-btn').disabled = false;
}

function checkAnswer(selected, correct, buttonElement) {
  const isCorrect = String(selected).trim() === String(correct).trim();
  
  const allButtons = document.querySelectorAll('#choices button');
  allButtons.forEach(btn => {
    btn.disabled = true;
    btn.style.cursor = 'not-allowed';
  });
  
  if (buttonElement) {
    buttonElement.classList.add('selected');
  }
  
  if (isCorrect) {
    correctAnswers++;
  }
  
  // æ—¥â†’è‹±ã®å ´åˆã€æ­£è§£ã®è‹±èªã‚’èª­ã¿ä¸Šã’
  if (questionDirection === 'J_to_E' && speechSupported) {
    speakText(currentQuestion.english, 'en-US');
  }
  
  testResults.push({
    wordId: currentQuestion.id,
    correct: isCorrect,
    direction: questionDirection,
    userAnswer: String(selected)
  });
  
  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã¯å³åº§ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
  if (isOnline) {
    saveAnswerRealtime(currentQuestion.id, isCorrect, questionDirection, String(selected));
  }
  
  showFeedback(isCorrect, correct);
  
  if (autoSaveEnabled) {
    saveProgress();
  }
}

function markAsIncorrect() {
  const correctAnswer = questionDirection === 'E_to_J' ? currentQuestion.japanese : currentQuestion.english;
  
  document.getElementById('show-choices-btn').disabled = true;
  document.getElementById('idk-btn').disabled = true;

  const allButtons = document.querySelectorAll('#choices button');
  allButtons.forEach(btn => {
    btn.disabled = true;
    btn.style.cursor = 'not-allowed';
  });
  
  testResults.push({
    wordId: currentQuestion.id,
    correct: false,
    direction: questionDirection,
    userAnswer: 'ã‚ã‹ã‚‰ãªã„'
  });
  
  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã¯å³åº§ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
  if (isOnline) {
    saveAnswerRealtime(currentQuestion.id, false, questionDirection, 'ã‚ã‹ã‚‰ãªã„');
  }
  
  showFeedback(false, correctAnswer);
  
  if (autoSaveEnabled) {
    saveProgress();
  }
}

function showFeedback(isCorrect, correctAnswer) {
  const feedbackEl = document.getElementById('feedback');
  const nextBtn = document.getElementById('next-btn');
  
  feedbackEl.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
  feedbackEl.textContent = isCorrect ? 'âœ“ æ­£è§£ï¼' : `âœ— ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${correctAnswer}ã€ã§ã™ã€‚`;
  
  if (currentQuestionIndex >= totalQuestions) {
    nextBtn.innerHTML = 'çµæœç”»é¢ã¸ â†’';
  } else {
    nextBtn.innerHTML = 'æ¬¡ã®å•é¡Œã¸ â†’';
  }
  nextBtn.classList.remove('hidden');
}

function resetState() {
  document.getElementById('choices-container').classList.add('hidden');
  document.getElementById('choices').innerHTML = '';
  document.getElementById('feedback').textContent = '';
  document.getElementById('feedback').className = '';
  document.getElementById('next-btn').classList.add('hidden');
  document.getElementById('show-choices-btn').classList.remove('hidden');
  document.getElementById('idk-btn').classList.remove('hidden');
  
  document.getElementById('show-choices-btn').disabled = false;
  document.getElementById('idk-btn').disabled = false;
}

// ===================================
// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜æ©Ÿèƒ½
// ===================================
function saveAnswerRealtime(wordId, isCorrect, direction, userAnswer) {
  const english = currentQuestion.english;
  const japanese = currentQuestion.japanese;
  
  google.script.run
    .withSuccessHandler(function(response) {
      console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜æˆåŠŸ:', wordId);
    })
    .withFailureHandler(function(error) {
      console.error('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    })
    .logTestResult(wordId, isCorrect, direction, userAnswer, english, japanese, currentBookId);
}

// ===================================
// é€²æ—ä¿å­˜æ©Ÿèƒ½
// ===================================
function saveProgress() {
  const progress = {
    testMode: testMode,
    currentQuestionIndex: currentQuestionIndex,
    totalQuestions: totalQuestions,
    correctAnswers: correctAnswers,
    testResults: testResults,
    currentTestWords: currentTestWords,
    testStartTime: testStartTime,
    lastTestSettings: lastTestSettings,
    currentBookId: currentBookId
  };
  
  try {
    localStorage.setItem('testProgress', JSON.stringify(progress));
    console.log('é€²æ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  } catch (e) {
    console.error('é€²æ—ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function loadProgress() {
  try {
    const saved = localStorage.getItem('testProgress');
    if (saved) {
      const progress = JSON.parse(saved);
      
      const now = new Date();
      const savedTime = new Date(progress.testStartTime);
      const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
      
      if (hoursDiff < 24) {
        return progress;
      }
    }
  } catch (e) {
    console.error('é€²æ—èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
  }
  return null;
}

function clearProgress() {
  try {
    localStorage.removeItem('testProgress');
    console.log('é€²æ—ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  } catch (e) {
    console.error('é€²æ—ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function restoreProgress() {
  const progress = loadProgress();
  
  if (progress) {
    if (confirm('å‰å›ã®ç¶šãã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ')) {
      testMode = progress.testMode;
      currentQuestionIndex = progress.currentQuestionIndex;
      totalQuestions = progress.totalQuestions;
      correctAnswers = progress.correctAnswers;
      testResults = progress.testResults;
      currentTestWords = progress.currentTestWords;
      testStartTime = new Date(progress.testStartTime);
      lastTestSettings = progress.lastTestSettings || lastTestSettings;
      currentBookId = progress.currentBookId || currentBookId;
      
      changeScreen('test-screen');
      nextQuestion();
      
      return true;
    } else {
      clearProgress();
    }
  }
  
  return false;
}

// ===================================
// çµæœç”»é¢
// ===================================
function showEndScreen() {
  changeScreen('end-screen');
  
  const accuracyPercent = Math.round((correctAnswers / totalQuestions) * 100);
  
  document.getElementById('final-score').textContent = `${correctAnswers} / ${totalQuestions}`;
  document.getElementById('final-accuracy').textContent = accuracyPercent + '%';
  
  let message = '';
  if (accuracyPercent === 100) {
    message = 'å®Œç’§ã§ã™ï¼ğŸ‰';
  } else if (accuracyPercent >= 80) {
    message = 'ç´ æ™´ã‚‰ã—ã„ï¼';
  } else if (accuracyPercent >= 60) {
    message = 'ã‚ˆãã§ãã¾ã—ãŸï¼';
  } else {
    message = 'å¼•ãç¶šãé ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
  }
  document.getElementById('result-message').textContent = message;
  
  saveResults();
  clearProgress();
}

function saveResults() {
  const resultsData = {
    totalQuestions: totalQuestions,
    correctAnswers: correctAnswers,
    wordResults: testResults
  };
  
  // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ä¿ç•™ãƒªã‚¹ãƒˆã«è¿½åŠ 
  if (!isOnline) {
    pendingTestResults.push(resultsData);
    savePendingResults();
    console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼šçµæœã‚’ä¿ç•™ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ');
    document.getElementById('xp-gained').textContent = '+' + correctAnswers + ' XPï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰';
    return;
  }
  
  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜æ¸ˆã¿ãªã®ã§çµ±è¨ˆæ›´æ–°ã¨XPè¡¨ç¤ºã®ã¿
  console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜æ¸ˆã¿ã€‚çµ±è¨ˆã‚’æ›´æ–°ã—ã¾ã™');
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        userStats = response.stats;
        const xpGained = correctAnswers; // 1å•1XP
        document.getElementById('xp-gained').textContent = '+' + xpGained + ' XP';
        updateDashboard();
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
        saveToCache(allWords, response.stats, recentlyTestedIds, availableBooks);
      } else {
        console.error('çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', response.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error('çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      const xpGained = correctAnswers;
      document.getElementById('xp-gained').textContent = '+' + xpGained + ' XP';
    })
    .updateWordStatisticsFromAllLog(currentBookId);
}

// ===================================
// ç”»é¢é·ç§»
// ===================================
function changeScreen(activeScreenId) {
  document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
  document.getElementById(activeScreenId).classList.add('active');
}

function showMenuScreen() {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿
  const cached = loadFromCache();
  if (cached) {
    console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º');
    allWords = cached.words;
    allWordsForChoices = cached.words;
    userStats = cached.stats;
    availableBooks = cached.availableBooks || [];
    
    initializeMenu();
    changeScreen('menu-screen');
    
    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ›´æ–°
    refreshDataInBackground();
  } else {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯é€šå¸¸é€šã‚Š
    changeScreen('loading-screen');
    fetchWordData();
  }
}

function confirmExit() {
  if (confirm('ãƒ†ã‚¹ãƒˆã‚’çµ‚äº†ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\nï¼ˆé€²æ—ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ï¼‰')) {
    saveProgress();
    showMenuScreen();
  }
}

// ===================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// ===================================
function shuffle(array) {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

// ===================================
// éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½
// ===================================
function speakText(text, lang = 'en-US') {
  if (!speechSupported) {
    console.warn('éŸ³å£°èª­ã¿ä¸Šã’ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }
  
  // æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢
  speechSynthesis.cancel();
  
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = lang;
  utterance.rate = 0.9; // å°‘ã—ã‚†ã£ãã‚Š
  utterance.pitch = 1.0;
  utterance.volume = 1.0;
  
  speechSynthesis.speak(utterance);
}

// å•é¡Œã®éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆè‹±èªã®ã¿ï¼‰
function speakQuestion() {
  if (questionDirection === 'E_to_J' && currentQuestion) {
    speakText(currentQuestion.english, 'en-US');
  }
}

// ===================================
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«é€²æ—ã‚’å¾©å…ƒ
// ===================================
window.addEventListener('load', function() {
  setTimeout(function() {
    if (document.getElementById('menu-screen').classList.contains('active')) {
      restoreProgress();
    }
  }, 1000);
});
</script>